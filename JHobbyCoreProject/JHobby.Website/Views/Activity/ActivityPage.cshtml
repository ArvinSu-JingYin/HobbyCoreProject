@section Styles {
    <!-- Bootstrap DateTime Picker -->
    <link rel="stylesheet" href="~/assets/css/bootstrap-datetimepicker.min.css">
    <!-- Fancybox CSS -->
    <link rel="stylesheet" href="~/assets/plugins/fancybox/jquery.fancybox.min.css">
}

@{
    int activityId = ViewBag.activityId;
    int verifyMemberId = ViewBag.verifyMemberId;
    bool blnLogIn = ViewBag.logIn;
}

<partial name="_BreadcrumbPartial" />

<!-- Main Wrapper -->
<div id="activity" class="main-wrapper venue-coach-details">
    <!--Galler Slider Section-->
    <div class="bannergallery-section">
        <div class="main-gallery-slider owl-carousel owl-theme">
            <div class="gallery-widget-item" v-for="item in activity.activityImages">
                <a :href="item.imageName" data-fancybox="gallery1">
                    <img style="width:440px;height:380px" class="img-fluid" alt="Image" :src="item.imageName">
                </a>
            </div>
        </div>
        @*         <div class="showphotos corner-radius-10">
        <a href="~/assets/img/gallery/gallery1/gallery-03.png" data-fancybox="gallery1"><i class="fa-regular fa-images"></i>More Photos</a>
        </div> *@
    </div>
    <div class="venue-info white-bg d-block">
        <div class="container">
            <div class="row">
                <div class="col-12 col-sm-12 col-md-12 col-lg-12">
                    <h1 class="d-flex align-items-center justify-content-start">{{activity.activityName}}</h1>
                    <ul class="d-sm-flex justify-content-start align-items-center">
                        <li><i class="feather-users"></i>活動人數上限：{{activity.maxPeople}}</li>
                        <li><i class="feather-user-plus"></i>目前人數：{{activity.currentPeople}}</li>
                    </ul>
                    <ul class="d-sm-flex justify-content-start align-items-center">
                        <li><i class="feather-map-pin"></i>{{activity.activityLocation}}</li>
                        <li><i class="feather-clock"></i>活動開始日：{{activity.startDate}} {{activity.startTime}}</li>
                        <li><i class="feather-clock"></i>報名截止日：{{activity.joinDeadLine}}</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Page Content -->
    <div class="content">
        <div class="container">
            <!-- Row -->
            <div class="row">
                <div class="col-12 col-sm-12 col-md-12 col-lg-8">
                    <div class="venue-options white-bg mb-4">
                        <ul class="clearfix">
                            <li><a href="#overview">介紹</a></li>
                            <li><a href="#comments">留言版</a></li>
                            <li><a href="#location">地圖</a></li>
                        </ul>
                    </div>

                    <!-- Accordian Contents -->
                    <div class="accordion" id="accordionPanel">
                        <div class="accordion-item mb-4" id="overview">
                            <h4 class="accordion-header" id="panelsStayOpen-overview">
                                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#panelsStayOpen-collapseOne" aria-expanded="true" aria-controls="panelsStayOpen-collapseOne">
                                    介紹
                                </button>
                            </h4>
                            <div id="panelsStayOpen-collapseOne" class="accordion-collapse collapse show" aria-labelledby="panelsStayOpen-overview">
                                <div class="accordion-body">
                                    <div class="text show-more-height">
                                        <p>{{activity.activityNotes}}</p>
                                    </div>
                                    <div class="show-more d align-items-center primary-text"><i class="feather-plus-circle"></i>顯示較多</div>
                                </div>
                            </div>
                        </div>
                        <div class="accordion-item mb-4" id="comments">
                            <h4 class="accordion-header" id="panelsStayOpen-location">
                                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#panelsStayOpen-comments" aria-expanded="false" aria-controls="panelsStayOpen-collapseSeven">
                                    留言版
                                </button>
                            </h4>
                            <div id="panelsStayOpen-comments" class="accordion-collapse collapse show" aria-labelledby="panelsStayOpen-comments">
                                <div class="accordion-body">
                                    <!-- Comments -->
                                    <div class="blog-comments">
                                        <template v-if="blnMsg">
                                            <div class="dull-bg">
                                                <hr>
                                                <ul>
                                                    <li class="author-group d-md-flex align-items-center justify-content-start" v-for="item in msgBord">
                                                        <div class="profile-pic">
                                                            <a :href='"@Url.Action("MemberProfile","MemberCenter")/"+item.memberId' class="d-inline-block"><img :src="item.headShot" alt="User"></a>
                                                        </div>
                                                        <div class="info">
                                                            <div class="head d-flex align-items-center justify-content-start">
                                                                <h5>{{item.nickName}}</h5>
                                                                <i class="fa-solid fa-circle"></i>
                                                                <span>{{item.messageDate}} {{item.messageTime}}</span>
                                                            </div>
                                                            <p>{{item.messageText}}</p>
                                                        </div>
                                                    </li>
                                                </ul>
                                            </div>
                                        </template>
                                        <template v-else>
                                            <div class="dull-bg">
                                                <ul>
                                                    <li>
                                                        <div>
                                                            <p>這個活動還沒有人留言哦</p>
                                                        </div>
                                                    </li>
                                                </ul>
                                            </div>
                                        </template>
                                        <div class="card new-comment white-bg">
                                            <form>
                                                <div class="mb-3">
                                                    <textarea v-model="message" class="form-control" id="comments" rows="3" placeholder="留下您想說的話"></textarea>
                                                </div>
                                                <button type="button" class="btn btn-gradient" v-on:click="CreateMsg()">送出</button>
                                            </form>
                                        </div>
                                    </div>
                                    <!-- /Comments -->
                                </div>
                            </div>
                        </div>
                        <div class="accordion-item mb-4" id="location">
                            <h4 class="accordion-header" id="panelsStayOpen-location">
                                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#panelsStayOpen-collapseSeven" aria-expanded="false" aria-controls="panelsStayOpen-collapseSeven">
                                    地圖
                                </button>
                            </h4>
                            <div id="panelsStayOpen-collapseSeven" class="accordion-collapse collapse show" aria-labelledby="panelsStayOpen-location">
                                <div class="accordion-body">
                                    <div class="google-maps">
                                        <iframe width="100%" height="300" frameborder="0" v-bind:src="resultSrc"></iframe>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Accordian Contents -->
                </div>
                <aside class="col-12 col-sm-12 col-md-12 col-lg-4 theiaStickySidebar">
                    <div class="white-bg cage-owner-info">
                        <h4 class="border-bottom">活動主評價</h4>
                        <div class="d-flex justify-content-start align-items-center">
                            <div class="profile-pic">
                                <a :href='"@Url.Action("MemberProfile","MemberCenter")/"+profile.memberId'><img class="img-fluid" alt="User" :src="profile.headShot"></a>
                            </div>
                            <div class="">
                                <h5>{{profile.nickName}}</h5>
                                <div class="rating">
                                    <i class="fas fa-star filled" v-for="n in Math.floor(star)"></i>
                                    <i class="fas fa-star-half-alt" v-if="!Number.isInteger(star)"></i>
                                    <i class="fa-regular fa-star filled" v-for="x in 5-Math.ceil(star)"></i>
                                    <span>({{star}})</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <template v-if="joinBtnCheck.blnMemberStatus">
                        <div class="d-grid btn-block">
                            <button disabled class="btn btn-secondary d-inline-flex justify-content-center align-items-center" type="submit">{{joinBtnCheck.message}}</button>
                        </div>
                    </template>
                    <template v-else>
                        <div class="d-grid btn-block">
                            <button v-on:click="CreateActivityUser()" class="btn btn-secondary d-inline-flex justify-content-center align-items-center" type="submit">{{joinBtnCheck.message}}<i class="feather-arrow-right-circle ms-1"></i></button>
                        </div>
                    </template>

                </aside>
            </div>
            <!-- /Row -->
        </div>
        <!-- /Container -->
        <section class="section innerpagebg">
            <div class="container">
                <div class="featured-slider-group">
                    <h3 class="mb-40">類似活動</h3>
                    <div class="row">
                        <div class="featured-slider-group ">
                            <div class="owl-carousel featured-venues-slider owl-theme">
                                <!-- Featured Item -->
                                <div class="featured-venues-item aos" data-aos="fade-up" v-for="item in activityList">
                                    <div class="listing-item mb-0">
                                        <div class="listing-img">
                                            <a v-bind:href='"/Activity/ActivityPage/"+item.activityId'>
                                                <img style="height:259px;width:417px" :src="item.activityImages[0].imageName" .jpg"' alt="Venue">
                                            </a>
                                            <div class="fav-item-venues">
                                                <div class="list-reviews">
                                                    <a href="javascript:void(0)" v-on:click="Fav(item.activityId)" v-bind:class="wish.includes(item.activityId)? 'fav-icon selected':'fav-icon'">
                                                        <i class="feather-heart"></i>
                                                    </a>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="listing-content">
                                            <h3 class="listing-title">
                                                <a v-bind:href='"/Activity/ActivityPage/"+item.activityId'>{{item.activityName}}</a>
                                            </h3>
                                            <div class="listing-details-group">
                                                <ul>
                                                    <li>
                                                        <span>
                                                            <i class="feather-book-open"></i>活動簡述：{{item.shotActivityNotes}}...
                                                        </span>
                                                    </li>
                                                    <li>
                                                        <span>
                                                            <i class="feather-map-pin"></i>活動地址：{{item.activityLocation}}
                                                        </span>
                                                    </li>
                                                    <li>
                                                        <span>
                                                            <i class="feather-calendar"></i>報名截止日 : <span class="primary-text">{{item.joinDeadLine}}</span>
                                                        </span>
                                                    </li>
                                                </ul>
                                            </div>
                                            <div class="listing-button">
                                                <div class="listing-venue-owner">
                                                    <a class="navigation" v-bind:href='"@Url.Action("MemberProfile","MemberCenter")/"+item.memberId'>
                                                        <img :src="item.headShot" alt="Venue">{{item.nickName}}
                                                    </a>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <!-- /Featured Item -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>
    <!-- /Page Content -->
</div>
<!-- /Main Wrapper -->
@section Scripts {
    <!-- Bootstrap DateTime Picker -->
    <script src="~/assets/js/moment.min.js"></script>
    <script src="~/assets/js/bootstrap-datetimepicker.min.js"></script>
    <!-- Fancybox JS -->
    <script src="~/assets/plugins/fancybox/jquery.fancybox.min.js"></script>
    <!-- Sticky Sidebar JS -->
    <script src="~/assets/plugins/theia-sticky-sidebar/ResizeSensor.js"></script>
    <script src="~/assets/plugins/theia-sticky-sidebar/theia-sticky-sidebar.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.6.0/axios.min.js" integrity="sha512-WrdC3CE9vf1nBf58JHepuWT4x24uTacky9fuzw2g/3L9JkihgwZ6Cfv+JGTtNyosOhEmttMtEZ6H3qJWfI7gIQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/3.3.4/vue.global.min.js"></script>
    <script>
        const activity = Vue.createApp({
            data() {
                return {
                    activity: {},
                    //activity: { "activityId": 1, "categoryId": 5, "categoryTypeId": 2, "activityName": "歡樂打籃球", "activityLocation": "台北市中正區徐州路2-1號", "startTime": "2023-12-15T00:00:00", "joinDeadLine": "2023-11-30T00:00:00", "activityNotes": "全場籃球", "imageName": null, "activityImages": [{ "activityImageId": 1, "activityId": 1, "imageName": "1Image01", "isCover": true, "uploadTime": "2023-11-10T00:00:00", "activity": null }, { "activityImageId": 2, "activityId": 1, "imageName": "1Image02", "isCover": false, "uploadTime": "2023-11-10T00:00:00", "activity": null }, { "activityImageId": 3, "activityId": 1, "imageName": "1Image03", "isCover": false, "uploadTime": "2023-11-10T00:00:00", "activity": null }] },
                    msgBord: [],
                    activityList: [],
                    wish: [],
                    profile: [],
                    joinBtnCheck: {},
                    resultSrc: "",
                    star: 0,
                    blnMsg: true,
                    message: "",
                    blnAction: true
                }
            },
            mounted() {
                let _this = this;
                _this.QueryActivity();
                _this.QueryMsgBord();
                _this.QueryMemeberStatus();
                _this.blnAction = blnChange(`@blnLogIn`);
            },
            methods: {
                QueryActivity() {
                    let _this = this;
                    axios.get("/ActivityApi/ActivitySearch/@activityId")
                        .then(res => {
                            _this.activity = res.data;
                            let strSrc1 = "https://www.google.com/maps?q=";
                            let strSrc2 = encodeURI(_this.activity.activityLocation);
                            let strSrc3 = "&hl=zh-TW&z=18&t=p&output=embed";
                            _this.resultSrc = strSrc1 + strSrc2 + strSrc3;
                            _this.GetCategoryTypeList();
                            _this.QueryProfile();
                        })
                        .catch(err => alert(err));
                },
                QueryMsgBord() {
                    let _this = this;
                    axios.get("/ActivityApi/MemberMsg/@activityId")
                        .then(res => {
                            _this.msgBord = res.data;
                            if (_this.msgBord.length == 0) {
                                _this.blnMsg = false;
                            }
                        })
                        .catch(err => alert(err));
                },
                QueryProfile() {
                    let _this = this;
                    axios.get(`/ProfileApi/GetProfileById/${_this.activity.memberId}`)
                        .then(res => {
                            _this.profile = res.data;
                            _this.star = _this.profile.fraction;
                        })
                        .catch(err => alert(err));
                },
                QueryMemeberStatus() {
                    let _this = this;
                    if (!_this.blnAction) return
                    axios.get("/ActivityApi/GetMemberJoinStatus/@verifyMemberId/@activityId")
                        .then(res => {
                            _this.joinBtnCheck = res.data;
                        })
                        .catch(err => alert(err));
                },
                GetCategoryTypeList() {
                    let _this = this;
                    var form = new FormData();
                    form.append("categoryId", _this.activity.categoryId);
                    form.append("categoryTypeId", _this.activity.categoryTypeId);
                    axios.post("/MiddleCenterApi/GetCategoryTypeList", form, {
                        headers: {
                            "Content-Type": "multipart/form-data"
                        }
                    })
                        .then(res => {
                            _this.activityList = res.data;
                        })
                        .catch(err => alert(err));
                    _this.QueryWish();
                },
                QueryWish() {
                    let _this = this;
                    if (!_this.blnAction) return
                    axios.get("/WishApi/GetWishList/@verifyMemberId")
                        .then(res => _this.wish = res.data)
                        .catch(err => alert(err));
                },
                Fav(id) {
                    let _this = this;
                    if (!_this.blnAction) return
                    if (_this.wish.includes(id)) {
                        axios.delete(`/WishApi/DeleteWish/@verifyMemberId/${id}`)
                            .then(res => _this.QueryWish())
                            .catch(err => alert(err));
                    }
                    else {
                        let _this = this;
                        var form = new FormData();
                        form.append("memberId", @verifyMemberId);
                        form.append("activityId", id);
                        form.append("addTime", GetDateTime());
                        axios.post("/WishApi/InsertWish", form, {
                            headers: {
                                "Content-Type": "multipart/form-data"
                            }
                        })
                            .then(res => _this.QueryWish())
                            .catch(err => alert(err));
                    }
                    //_this.GetCategoryTypeList();
                },
                CreateMsg() {
                    let _this = this;
                    if (!_this.blnAction) return
                    if (_this.message !== "") {
                        var form = new FormData();
                        form.append("memberId", @verifyMemberId);
                        form.append("activityId", _this.activity.activityId);
                        form.append("messageTime", GetDateTime());
                        form.append("messageText", _this.message);
                        axios.post("/ActivityApi/MemberCreateMsg", form, {
                            headers: {
                                "Content-Type": "multipart/form-data"
                            }
                        }).then(res => {
                            _this.blnMsg = true;
                            _this.QueryMsgBord();
                        }).catch(err => alert("請重新輸入"));
                        //_this.QueryActivity();

                    } else {
                        alert("請輸入留言")
                    }
                    _this.message = "";
                },
                CreateActivityUser() {
                    let _this = this;
                    if (!_this.blnAction) return
                    var form = new FormData();
                    form.append("memberId", @verifyMemberId);
                    form.append("activityId", @activityId);
                    form.append("reviewStatus", 2);
                    form.append("reviewTime", GetDateTime());
                    axios.post("/ActivityApi/ActivityUserCreate", form, {
                        headers: {
                            "Content-Type": "multipart/form-data"
                        }
                    })
                        .then(res => {
                            if (res.data == true) {
                                alert("參加成功");
                                _this.QueryMemeberStatus()
                            } else {
                                alert("您已參加過")
                            }
                        })
                        .catch(err => alert(err));
                },
            }
        }).mount("#activity")
        Jhobby_ShowMore();

    </script>
}